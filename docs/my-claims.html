<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Claim Cipher - My Claims</title>
    <link rel="stylesheet" href="styles.css?v=4" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navigation Menu -->
    <nav class="nav-menu">
      <div class="nav-left">
        <span class="nav-brand">‚ö° Claim Cipher</span>
        <a href="my-claims.html" class="active">üìã My Claims</a>
        <a href="notifications.html" style="position: relative">
          üîî Notifications
          <span
            id="notification-badge"
            style="
              display: none;
              position: absolute;
              top: -4px;
              right: -8px;
              background: #ef4444;
              color: white;
              border-radius: 50%;
              width: 18px;
              height: 18px;
              font-size: 11px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          ></span>
        </a>
      </div>
      <div class="nav-right">
        <button class="nav-logout" onclick="handleLogout()">Logout</button>
      </div>
    </nav>

    <div
      style="
        min-height: 100vh;
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        padding: 16px;
        box-sizing: border-box;
      "
    >
      <div class="topbar">
        <div class="left">
          <h3>My Claims</h3>
        </div>
      </div>

      <div
        id="status-summary"
        style="
          display: flex;
          gap: 16px;
          margin: 16px 0;
          justify-content: center;
          flex-wrap: wrap;
        "
      ></div>

      <div id="claims-container">
        <div style="text-align: center; color: #a0aec0; padding: 40px">
          Loading claims...
        </div>
      </div>
    </div>

    <script src="js/config.js?v=4"></script>
    <script>
      let currentUserId = null;

      // Check authentication
      supabaseClient.auth.getSession().then(({ data: { session } }) => {
        if (!session) {
          window.location.href = "index.html";
          return;
        }
        currentUserId = session.user.id;
        loadMyClaims();
        checkNotifications();
      });

      async function handleLogout() {
        await supabaseClient.auth.signOut();
        window.location.href = "index.html";
      }

      async function checkNotifications() {
        try {
          const { data: notifications, error } = await supabaseClient
            .from("notifications")
            .select("id")
            .eq("user_id", currentUserId)
            .eq("is_read", false);

          if (error) throw error;

          const unreadCount = (notifications || []).length;

          if (unreadCount > 0) {
            const badge = document.getElementById("notification-badge");
            badge.textContent = unreadCount > 9 ? "9+" : unreadCount;
            badge.style.display = "flex";
          }
        } catch (error) {
          console.error("Error checking notifications:", error);
        }
      }

      async function loadMyClaims() {
        try {
          const { data, error } = await supabaseClient
            .from("claims")
            .select("*")
            .eq("assigned_to", currentUserId)
            .order("appointment_start", { ascending: true });

          if (error) throw error;
          renderClaims(data || []);
        } catch (error) {
          console.error("Error loading claims:", error);

          // Check if it's an authentication error
          if (
            error.message?.includes("JWT") ||
            error.code === "PGRST301" ||
            error.message?.includes("401")
          ) {
            alert("Your session has expired. Please log in again.");
            window.location.href = "index.html";
            return;
          }

          document.getElementById("claims-container").innerHTML =
            '<div style="text-align:center; color:#ef4444; padding:40px;">Error loading claims. Please refresh the page.</div>';
        }
      }

      function renderClaims(claims) {
        // Calculate status counts
        const scheduledCount = claims.filter(
          (c) => c.status === "SCHEDULED"
        ).length;
        const inProgressCount = claims.filter(
          (c) => c.status === "IN_PROGRESS"
        ).length;
        const completedCount = claims.filter(
          (c) => c.status === "COMPLETED"
        ).length;

        // Update status summary
        document.getElementById("status-summary").innerHTML = `
          <div style="background:#2d3748; padding:16px 24px; border-radius:8px; border:2px solid #3b82f6;">
            <div style="font-size:24px; font-weight:bold; color:#3b82f6;">${scheduledCount}</div>
            <div style="color:#e2e8f0; font-size:14px;">üìÖ Scheduled</div>
          </div>
          <div style="background:#2d3748; padding:16px 24px; border-radius:8px; border:2px solid #f59e0b;">
            <div style="font-size:24px; font-weight:bold; color:#f59e0b;">${inProgressCount}</div>
            <div style="color:#e2e8f0; font-size:14px;">‚öôÔ∏è In Progress</div>
          </div>
          <div style="background:#2d3748; padding:16px 24px; border-radius:8px; border:2px solid #10b981;">
            <div style="font-size:24px; font-weight:bold; color:#10b981;">${completedCount}</div>
            <div style="color:#e2e8f0; font-size:14px;">‚úÖ Completed</div>
          </div>
        `;

        if (claims.length === 0) {
          document.getElementById("claims-container").innerHTML =
            '<div style="text-align:center; color:#a0aec0; padding:40px;">No claims assigned to you</div>';
          return;
        }

        // Group claims by date
        const groupedClaims = groupClaimsByDate(claims);

        let html = "";
        for (const [dateKey, dateClaims] of Object.entries(groupedClaims)) {
          html += `
            <div style="margin-bottom:32px;">
              <h3 style="color:#e2e8f0; margin:16px 0; padding:12px; background:rgba(102, 126, 234, 0.2); border-left:4px solid #667eea; border-radius:4px;">
                üìÖ ${dateKey} <span style="color:#a0aec0; font-size:16px; font-weight:normal;">(${
            dateClaims.length
          } claim${dateClaims.length !== 1 ? "s" : ""})</span>
              </h3>
              <div class="grid">
                ${dateClaims
                  .map(
                    (claim) => `
                  <a class="claim-card" href="claim-detail.html?id=${claim.id}">
                    <span class="status ${getStatusClass(claim.status)}">${
                      claim.status
                    }</span>
                    <h4>#${claim.claim_number}</h4>
                    <section>
                      <div class="title">Customer</div>
                      <div class="content">${claim.customer_name}</div>
                    </section>
                    <section>
                      <div class="title">üìÖ Appointment</div>
                      <div class="content">${formatAppointment(claim)}</div>
                    </section>
                    <section>
                      <div class="title">üöó Vehicle Info</div>
                      <div class="content">${claim.vehicle_year || ""} ${
                      claim.vehicle_make || ""
                    } ${claim.vehicle_model || ""}</div>
                    </section>
                  </a>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        }

        document.getElementById("claims-container").innerHTML = html;
      }

      function groupClaimsByDate(claims) {
        const groups = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);

        claims.forEach((claim) => {
          let dateKey;

          if (!claim.appointment_start) {
            dateKey = "No Appointment Set";
          } else {
            const aptDate = new Date(claim.appointment_start);
            aptDate.setHours(0, 0, 0, 0);

            if (claim.status === "COMPLETED") {
              dateKey = "Completed";
            } else if (aptDate.getTime() === today.getTime()) {
              dateKey = "Today";
            } else if (aptDate.getTime() === tomorrow.getTime()) {
              dateKey = "Tomorrow";
            } else if (aptDate < today) {
              dateKey = "Overdue";
            } else if (aptDate < nextWeek) {
              dateKey = "This Week";
            } else {
              dateKey = aptDate.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric",
                year: "numeric",
              });
            }
          }

          if (!groups[dateKey]) {
            groups[dateKey] = [];
          }
          groups[dateKey].push(claim);
        });

        // Sort groups by priority
        const sortOrder = ["Overdue", "Today", "Tomorrow", "This Week"];
        const sortedGroups = {};

        sortOrder.forEach((key) => {
          if (groups[key]) sortedGroups[key] = groups[key];
        });

        // Add other dated groups
        Object.keys(groups)
          .sort()
          .forEach((key) => {
            if (
              !sortOrder.includes(key) &&
              key !== "No Appointment Set" &&
              key !== "Completed"
            ) {
              sortedGroups[key] = groups[key];
            }
          });

        // Add No Appointment and Completed at the end
        if (groups["No Appointment Set"])
          sortedGroups["No Appointment Set"] = groups["No Appointment Set"];
        if (groups["Completed"])
          sortedGroups["Completed"] = groups["Completed"];

        return sortedGroups;
      }

      function getStatusClass(status) {
        const map = {
          COMPLETED: "completed",
          IN_PROGRESS: "in-progress",
          SCHEDULED: "scheduled",
          NONE: "none",
        };
        return map[status] || "none";
      }

      function formatAppointment(claim) {
        if (!claim.appointment_start) return "No appointment scheduled";

        // Parse the ISO string and display the exact time stored
        const date = new Date(claim.appointment_start);

        // Format date and time without timezone conversion
        const options = {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        };

        return `Start: ${date.toLocaleString("en-US", options)}`;
      }
    </script>
  </body>
</html>
