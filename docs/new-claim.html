<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Claim Cipher - New Claim</title>
    <link rel="stylesheet" href="styles.css?v=4" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navigation Menu -->
    <nav class="nav-menu">
      <div class="nav-left">
        <span class="nav-brand">âš¡ Claim Cipher</span>
        <a href="admin.html">ðŸ“‹ Claims</a>
        <a href="new-claim.html" class="active">âž• New Claim</a>
      </div>
      <div class="nav-right">
        <button class="nav-logout" onclick="handleLogout()">Logout</button>
      </div>
    </nav>

    <div
      style="
        min-height: 100vh;
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        padding: 16px;
        box-sizing: border-box;
      "
    >
      <div class="topbar">
        <div class="left">
          <h3>New Claim</h3>
        </div>
      </div>
      <div class="container" style="align-items: flex-start">
        <div class="card" style="max-width: 600px">
          <div
            id="error-msg"
            style="
              display: none;
              color: #ef4444;
              margin-bottom: 16px;
              text-align: center;
            "
          ></div>
          <div
            id="success-msg"
            style="
              display: none;
              color: #10b981;
              margin-bottom: 16px;
              text-align: center;
            "
          ></div>
          <form id="claim-form">
            <label>Claim Number</label>
            <input
              type="text"
              id="claim_number"
              placeholder="Enter claim number"
              required
            />

            <label>Customer Name</label>
            <input
              type="text"
              id="customer_name"
              placeholder="Enter customer name"
              required
            />

            <label>Phone</label>
            <input type="tel" id="phone" placeholder="Enter phone number" />

            <label>Email</label>
            <input type="email" id="email" placeholder="Enter email" />

            <label>Firm Name (Insurance Company)</label>
            <input type="text" id="firm_name" placeholder="Enter insurance company / firm name" />

            <label>VIN</label>
            <input type="text" id="vin" placeholder="Enter VIN" />

            <label>Vehicle Year</label>
            <input type="text" id="vehicle_year" placeholder="2024" />

            <label>Vehicle Make</label>
            <input type="text" id="vehicle_make" placeholder="Make" />

            <label>Vehicle Model</label>
            <input type="text" id="vehicle_model" placeholder="Model" />

            <label>Address Line 1</label>
            <input type="text" id="address_line1" placeholder="Enter address" />

            <label>Address Line 2 (optional)</label>
            <input
              type="text"
              id="address_line2"
              placeholder="Apt, Suite, etc."
            />

            <label>City</label>
            <input type="text" id="city" placeholder="City" />

            <label>State</label>
            <input type="text" id="state" placeholder="State" />

            <label>Postal Code</label>
            <input type="text" id="postal_code" placeholder="Postal code" />

            <label>Appointment Start Date &amp; Time</label>
            <input type="datetime-local" id="appointment_start" />

            <label>Appointment End Date &amp; Time</label>
            <input type="datetime-local" id="appointment_end" />

            <label>Assign Appraiser</label>
            <select id="assigned_to">
              <option value="">Unassigned</option>
            </select>

            <label>Status</label>
            <select id="status">
              <option value="SCHEDULED">Scheduled</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="COMPLETED">Completed</option>
              <option value="CANCELED">Canceled</option>
            </select>

            <label>Notes</label>
            <textarea
              id="notes"
              rows="4"
              style="
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 1px solid #4a5568;
                border-radius: 6px;
                background: #2d3748;
                color: #e2e8f0;
                margin-bottom: 16px;
                box-sizing: border-box;
                font-family: inherit;
              "
            ></textarea>

            <button type="submit">Create Claim</button>
          </form>
        </div>
      </div>
    </div>

    <script src="js/config.js?v=4"></script>
    <script>
      const claimForm = document.getElementById("claim-form");
      const errorMsg = document.getElementById("error-msg");
      const successMsg = document.getElementById("success-msg");
      let allAppraisers = [];

      async function handleLogout() {
        await supabaseClient.auth.signOut();
        window.location.href = "index.html";
      }

      // Check authentication and load appraisers
      (async () => {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (!session) {
          window.location.href = "index.html";
          return;
        }

        // Load appraisers for assignment dropdown
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("user_id, full_name, role")
          .eq("role", "appraiser")
          .order("full_name");

        if (!error && data) {
          allAppraisers = data;
          const select = document.getElementById("assigned_to");
          data.forEach((appraiser) => {
            const option = document.createElement("option");
            option.value = appraiser.user_id;
            option.textContent = appraiser.full_name;
            select.appendChild(option);
          });
        }
      })();

      claimForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.style.display = "none";
        successMsg.style.display = "none";

        const formData = {
          claim_number: document.getElementById("claim_number").value,
          customer_name: document.getElementById("customer_name").value,
          phone: document.getElementById("phone").value || null,
          email: document.getElementById("email").value || null,
          firm_name: document.getElementById("firm_name").value || null,
          vin: document.getElementById("vin").value || null,
          vehicle_year: document.getElementById("vehicle_year").value || null,
          vehicle_make: document.getElementById("vehicle_make").value || null,
          vehicle_model: document.getElementById("vehicle_model").value || null,
          address_line1: document.getElementById("address_line1").value || null,
          address_line2: document.getElementById("address_line2").value || null,
          city: document.getElementById("city").value || null,
          state: document.getElementById("state").value || null,
          postal_code: document.getElementById("postal_code").value || null,
          appointment_start:
            document.getElementById("appointment_start").value || null,
          appointment_end:
            document.getElementById("appointment_end").value || null,
          assigned_to: document.getElementById("assigned_to").value || null,
          status: document.getElementById("status").value,
          notes: document.getElementById("notes").value || null,
        };

        try {
          const { data, error } = await supabaseClient
            .from("claims")
            .insert([formData])
            .select()
            .single();

          if (error) throw error;

          successMsg.textContent = "Claim created successfully!";
          successMsg.style.display = "block";

          setTimeout(() => {
            window.location.href = "admin.html";
          }, 1500);
        } catch (error) {
          console.error("Error creating claim:", error);
          errorMsg.textContent = error.message;
          errorMsg.style.display = "block";
        }
      });
    </script>
  </body>
</html>
