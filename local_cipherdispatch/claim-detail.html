<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claim Cipher - Claim Detail</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
      .detail-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .detail-card {
        background: #2d3748;
        border: 1px solid #4a5568;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
      }
      .detail-card h4 {
        margin-top: 0;
        color: #e2e8f0;
        border-bottom: 2px solid #4a5568;
        padding-bottom: 8px;
        margin-bottom: 16px;
      }
      .detail-row {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
      }
      .detail-label {
        font-weight: bold;
        color: #e2e8f0;
        min-width: 120px;
      }
      .detail-value {
        color: #a0aec0;
        flex: 1;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        color: white;
      }
      .status-COMPLETED {
        background: #10b981;
      }
      .status-IN_PROGRESS {
        background: #f59e0b;
      }
      .status-SCHEDULED {
        background: #3b82f6;
      }
      .status-NONE {
        background: #6b7280;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 16px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.2s;
      }
      .btn:hover {
        opacity: 0.9;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .btn-scheduled {
        background: #3b82f6;
        color: white;
      }
      .btn-progress {
        background: #f59e0b;
        color: white;
      }
      .btn-complete {
        background: #10b981;
        color: white;
      }
      .btn-danger {
        background: #ef4444;
        color: white;
      }
      .btn-secondary {
        background: #4a5568;
        color: white;
      }
      .btn-map {
        background: #3b82f6;
        color: white;
      }

      .danger-zone {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #ef4444;
      }
      .danger-zone h5 {
        color: #ef4444;
        margin: 0 0 12px 0;
      }

      .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .photo-item {
        position: relative;
        height: 200px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid #4a5568;
      }
      .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .photo-delete {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }
      .lightbox.active {
        display: flex;
      }
      .lightbox-content {
        position: relative;
        max-width: 90%;
        max-height: 90vh;
      }
      .lightbox-img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
      }
      .lightbox-close {
        position: absolute;
        top: -50px;
        right: 0;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: bold;
      }
      .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 15px 25px;
        cursor: pointer;
        font-weight: bold;
        font-size: 24px;
      }
      .lightbox-prev {
        left: -80px;
      }
      .lightbox-next {
        right: -80px;
      }
      .lightbox-download {
        position: absolute;
        bottom: -60px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 30px;
        cursor: pointer;
        font-weight: bold;
      }

      select,
      input[type="datetime-local"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #4a5568;
        border-radius: 6px;
        background: #2d3748;
        color: #e2e8f0;
        font-size: 14px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div
      style="
        min-height: 100vh;
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        padding: 16px;
      "
    >
      <div class="detail-container">
        <div class="detail-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 12px;
            "
          >
            <h3 id="claim-title" style="margin: 0; color: #e2e8f0">
              Loading...
            </h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap">
              <button class="btn btn-secondary" onclick="history.back()">
                ‚Üê Back
              </button>
              <button class="btn btn-danger" onclick="handleLogout()">
                Logout
              </button>
            </div>
          </div>
        </div>

        <div id="claim-content">
          <div style="text-align: center; color: #a0aec0; padding: 40px">
            Loading claim...
          </div>
        </div>
      </div>
    </div>

    <div
      id="lightbox"
      class="lightbox"
      onclick="if(event.target.id==='lightbox') closeLightbox()"
    >
      <div class="lightbox-content">
        <button class="lightbox-close" onclick="closeLightbox()">
          ‚úï Close
        </button>
        <button class="lightbox-nav lightbox-prev" onclick="navigatePhoto(-1)">
          ‚Äπ
        </button>
        <img id="lightbox-img" class="lightbox-img" src="" alt="Photo" />
        <button class="lightbox-nav lightbox-next" onclick="navigatePhoto(1)">
          ‚Ä∫
        </button>
        <button class="lightbox-download" onclick="downloadCurrentPhoto()">
          ‚¨á Download
        </button>
      </div>
    </div>

    <script src="js/config.js"></script>
    <script>
      let currentClaim = null;
      let currentUser = null;
      let isAdmin = false;
      let allAppraisers = [];
      let photos = [];
      let currentPhotoIndex = 0;
      const urlParams = new URLSearchParams(window.location.search);
      const claimId = urlParams.get("id");

      async function handleLogout() {
        await supabaseClient.auth.signOut();
        window.location.href = "index.html";
      }

      (async function init() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (!session) {
          window.location.href = "index.html";
          return;
        }

        currentUser = session.user;

        const { data: profile } = await supabaseClient
          .from("profiles")
          .select("role")
          .eq("id", currentUser.id)
          .single();

        isAdmin = profile?.role === "admin";

        if (isAdmin) {
          const { data } = await supabaseClient
            .from("profiles")
            .select("id, email, role")
            .eq("role", "appraiser")
            .order("email");
          allAppraisers = data || [];
        }

        if (claimId) {
          await loadClaim();
        } else {
          document.getElementById("claim-content").innerHTML =
            '<div class="detail-card"><div style="text-align:center; color:#ef4444;">Invalid claim ID</div></div>';
        }
      })();

      async function loadClaim() {
        try {
          const { data, error } = await supabaseClient
            .from("claims")
            .select("*")
            .eq("id", claimId)
            .single();

          if (error) throw error;
          currentClaim = data;

          // Load appraiser info if assigned
          if (currentClaim.assigned_to) {
            const { data: appraiserData } = await supabaseClient
              .from("profiles")
              .select("id, email")
              .eq("id", currentClaim.assigned_to)
              .single();
            currentClaim.appraiser = appraiserData;
          }

          renderClaim();
          await loadPhotos();
        } catch (error) {
          console.error("Error loading claim:", error);
          document.getElementById("claim-content").innerHTML =
            '<div class="detail-card"><div style="text-align:center; color:#ef4444;">Error loading claim</div></div>';
        }
      }

      function renderClaim() {
        document.getElementById(
          "claim-title"
        ).textContent = `Claim #${currentClaim.claim_number}`;

        const fullAddress = [
          currentClaim.address,
          currentClaim.city,
          currentClaim.state,
          currentClaim.zip,
        ]
          .filter(Boolean)
          .join(", ");

        const mapUrl = fullAddress
          ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
              fullAddress
            )}`
          : null;

        let html = `
        <div class="detail-card">
          <h4>üë§ Customer Information</h4>
          <div class="detail-row">
            <span class="detail-label">Name:</span>
            <span class="detail-value">${currentClaim.customer_name}</span>
          </div>
          ${
            currentClaim.phone
              ? `
            <div class="detail-row">
              <span class="detail-label">Phone:</span>
              <span class="detail-value"><a href="tel:${currentClaim.phone}" style="color:#3b82f6;">${currentClaim.phone}</a></span>
            </div>
          `
              : ""
          }
          ${
            currentClaim.email
              ? `
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value"><a href="mailto:${currentClaim.email}" style="color:#3b82f6;">${currentClaim.email}</a></span>
            </div>
          `
              : ""
          }
          ${
            fullAddress
              ? `
            <div class="detail-row">
              <span class="detail-label">Address:</span>
              <span class="detail-value">${fullAddress}</span>
            </div>
            ${
              mapUrl
                ? `
              <div style="margin-top:12px;">
                <a href="${mapUrl}" target="_blank" class="btn btn-map">üìç Open in Maps</a>
              </div>
            `
                : ""
            }
          `
              : ""
          }
        </div>

        <div class="detail-card">
          <h4>üöó Vehicle Information</h4>
          ${
            currentClaim.vin
              ? `
            <div class="detail-row">
              <span class="detail-label">VIN:</span>
              <span class="detail-value">${currentClaim.vin}</span>
            </div>
          `
              : ""
          }
          <div class="detail-row">
            <span class="detail-label">Year:</span>
            <span class="detail-value">${
              currentClaim.vehicle_year || "N/A"
            }</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Make:</span>
            <span class="detail-value">${
              currentClaim.vehicle_make || "N/A"
            }</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Model:</span>
            <span class="detail-value">${
              currentClaim.vehicle_model || "N/A"
            }</span>
          </div>
        </div>

        ${
          currentClaim.notes
            ? `
          <div class="detail-card">
            <h4>üìù Accident Description / Notes</h4>
            <div style="white-space: pre-wrap; background:#1a202c; padding:16px; border-radius:6px; color:#e2e8f0;">
              ${currentClaim.notes}
            </div>
          </div>
        `
            : ""
        }
`;

        if (isAdmin) {
          html += `
        <div class="detail-card">
          <h4>‚öôÔ∏è Admin Controls</h4>
          
          <div style="margin-bottom:20px;">
            <strong style="color:#e2e8f0;">Current Status:</strong>
            <span class="status-badge status-${currentClaim.status}">${
            currentClaim.status
          }</span>
          </div>

          <div class="action-buttons">
            <button class="btn btn-scheduled" onclick="updateStatus('SCHEDULED')">
              üìÖ Mark Scheduled
            </button>
            <button class="btn btn-progress" onclick="updateStatus('IN_PROGRESS')">
              üîß Start Work
            </button>
            <button class="btn btn-complete" onclick="updateStatus('COMPLETED')">
              ‚úÖ Mark Complete
            </button>
          </div>

          <div style="margin-top:24px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#e2e8f0;">
              üë§ Assign Appraiser:
            </label>
            <select id="appraiser-select" onchange="assignAppraiser(this.value)">
              <option value="">Unassigned</option>
              ${allAppraisers
                .map(
                  (a) => `
                <option value="${a.id}" ${
                    currentClaim.assigned_to === a.id ? "selected" : ""
                  }>
                  ${a.email}
                </option>
              `
                )
                .join("")}
            </select>
          </div>

          <div style="margin-top:24px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#e2e8f0;">
              üìÖ Appointment Start:
            </label>
            <input type="datetime-local" id="apt-start" 
              value="${
                currentClaim.appointment_start
                  ? new Date(currentClaim.appointment_start)
                      .toISOString()
                      .slice(0, 16)
                  : ""
              }"
              onchange="updateAppointment('start', this.value)">
          </div>

          <div style="margin-top:16px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold; color:#e2e8f0;">
              üìÖ Appointment End:
            </label>
            <input type="datetime-local" id="apt-end"
              value="${
                currentClaim.appointment_end
                  ? new Date(currentClaim.appointment_end)
                      .toISOString()
                      .slice(0, 16)
                  : ""
              }"
              onchange="updateAppointment('end', this.value)">
          </div>

          <div class="danger-zone">
            <h5>‚ö†Ô∏è Danger Zone</h5>
            <button class="btn btn-danger" onclick="deleteClaim()">
              üóëÔ∏è Permanently Delete Claim
            </button>
            <p style="font-size:12px; color:#a0aec0; margin-top:8px;">
              ‚ö†Ô∏è This action cannot be undone. All photos and data will be permanently deleted.
            </p>
          </div>
        </div>
        `;
        } else {
          html += `
        <div class="detail-card">
          <h4>üìã Claim Status</h4>
          <div style="margin-bottom:16px;">
            <strong style="color:#e2e8f0;">Status:</strong>
            <span class="status-badge status-${currentClaim.status}">${
            currentClaim.status
          }</span>
          </div>
          ${
            currentClaim.appointment_start
              ? `
            <div class="detail-row">
              <span class="detail-label">Appointment Start:</span>
              <span class="detail-value">${new Date(
                currentClaim.appointment_start
              ).toLocaleString()}</span>
            </div>
          `
              : ""
          }
          ${
            currentClaim.appointment_end
              ? `
            <div class="detail-row">
              <span class="detail-label">Appointment End:</span>
              <span class="detail-value">${new Date(
                currentClaim.appointment_end
              ).toLocaleString()}</span>
            </div>
          `
              : ""
          }
        </div>
        `;
        }

        html += `
        <div class="detail-card">
          <h4>üì∏ Photos (<span id="photo-count">0</span>)</h4>
          <input type="file" id="photo-input" accept="image/*" multiple capture="environment" style="display:none;" onchange="handlePhotoUpload(event)">
          <button class="btn btn-primary" onclick="document.getElementById('photo-input').click()">
            üì∑ Upload Photos
          </button>
          <div id="photo-grid" class="photo-grid">
            <div style="text-align:center; color:#a0aec0; padding:40px; grid-column:1/-1;">Loading photos...</div>
          </div>
        </div>
      `;

        document.getElementById("claim-content").innerHTML = html;
      }

      async function updateStatus(status) {
        try {
          const { error } = await supabaseClient
            .from("claims")
            .update({ status })
            .eq("id", claimId);

          if (error) throw error;
          await loadClaim();
          alert(`Status updated to ${status}`);
        } catch (error) {
          alert("Error updating status: " + error.message);
        }
      }

      async function assignAppraiser(appraiserId) {
        try {
          const { error } = await supabaseClient
            .from("claims")
            .update({ assigned_to: appraiserId || null })
            .eq("id", claimId);

          if (error) throw error;
          await loadClaim();
          alert(
            appraiserId
              ? "Appraiser assigned successfully"
              : "Appraiser unassigned"
          );
        } catch (error) {
          alert("Error assigning appraiser: " + error.message);
        }
      }

      async function updateAppointment(type, value) {
        if (!value) return;

        try {
          const field =
            type === "start" ? "appointment_start" : "appointment_end";
          const { error } = await supabaseClient
            .from("claims")
            .update({ [field]: new Date(value).toISOString() })
            .eq("id", claimId);

          if (error) throw error;
          alert(`Appointment ${type} updated successfully`);
        } catch (error) {
          alert("Error updating appointment: " + error.message);
        }
      }

      async function deleteClaim() {
        const confirmed = confirm(
          `‚ö†Ô∏è WARNING: Are you sure you want to PERMANENTLY DELETE this claim?\n\n` +
            `Claim #${currentClaim.claim_number}\n` +
            `Customer: ${currentClaim.customer_name}\n\n` +
            `This action CANNOT be undone and will delete:\n` +
            `- The claim record\n` +
            `- All associated photos\n` +
            `- All related data\n\n` +
            `Type "DELETE" in the next dialog to confirm.`
        );

        if (!confirmed) return;

        const confirmText = prompt(
          'Type "DELETE" to confirm permanent deletion:'
        );
        if (confirmText !== "DELETE") {
          alert("Deletion cancelled - text did not match.");
          return;
        }

        try {
          if (photos.length > 0) {
            const paths = photos.map((p) => `${claimId}/${p.name}`);
            await supabaseClient.storage.from("claim-photos").remove(paths);
          }

          const { error } = await supabaseClient
            .from("claims")
            .delete()
            .eq("id", claimId);

          if (error) throw error;

          alert("Claim permanently deleted.");
          window.location.href = "admin.html";
        } catch (error) {
          alert("Error deleting claim: " + error.message);
        }
      }

      async function loadPhotos() {
        try {
          const { data, error } = await supabaseClient.storage
            .from("claim-photos")
            .list(`${claimId}/`, {
              sortBy: { column: "created_at", order: "desc" },
            });

          if (error) throw error;
          photos = data || [];
          document.getElementById("photo-count").textContent = photos.length;
          renderPhotos();
        } catch (error) {
          console.error("Error loading photos:", error);
          const grid = document.getElementById("photo-grid");
          if (grid)
            grid.innerHTML =
              '<div style="text-align:center; color:#a0aec0; padding:20px; grid-column:1/-1;">No photos yet</div>';
        }
      }

      function renderPhotos() {
        const grid = document.getElementById("photo-grid");
        if (!grid) return;

        if (photos.length === 0) {
          grid.innerHTML =
            '<div style="text-align:center; color:#a0aec0; padding:20px; grid-column:1/-1;">No photos yet. Upload some!</div>';
          return;
        }

        grid.innerHTML = photos
          .map((photo, index) => {
            const { data } = supabaseClient.storage
              .from("claim-photos")
              .getPublicUrl(`${claimId}/${photo.name}`);

            return `
          <div class="photo-item" onclick="openLightbox(${index})">
            <img src="${data.publicUrl}" alt="Claim photo" loading="lazy">
            <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto('${photo.name}')">‚úï</button>
          </div>
        `;
          })
          .join("");
      }

      async function handlePhotoUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        const uploadBtn = event.target.previousElementSibling;
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = "üì§ Uploading...";
        uploadBtn.disabled = true;

        try {
          const options = {
            maxSizeMB: 1.5,
            maxWidthOrHeight: 1600,
            useWebWorker: true,
          };

          for (let i = 0; i < files.length; i++) {
            uploadBtn.textContent = `üì§ Uploading ${i + 1}/${files.length}...`;
            const file = files[i];
            const compressedFile = await imageCompression(file, options);
            const fileName = `${Date.now()}-${i}-${file.name}`;
            const filePath = `${claimId}/${fileName}`;

            const { error } = await supabaseClient.storage
              .from("claim-photos")
              .upload(filePath, compressedFile);

            if (error) throw error;
          }

          await loadPhotos();
          alert(`${files.length} photo(s) uploaded successfully!`);
        } catch (error) {
          console.error("Error uploading photos:", error);
          alert("Error uploading photos: " + error.message);
        } finally {
          uploadBtn.textContent = originalText;
          uploadBtn.disabled = false;
          event.target.value = "";
        }
      }

      async function deletePhoto(fileName) {
        if (!confirm("Delete this photo? This cannot be undone.")) return;

        try {
          const { error } = await supabaseClient.storage
            .from("claim-photos")
            .remove([`${claimId}/${fileName}`]);

          if (error) throw error;
          await loadPhotos();
          closeLightbox();
        } catch (error) {
          alert("Error deleting photo: " + error.message);
        }
      }

      function openLightbox(index) {
        currentPhotoIndex = index;
        updateLightboxImage();
        document.getElementById("lightbox").classList.add("active");
      }

      function closeLightbox() {
        document.getElementById("lightbox").classList.remove("active");
      }

      function navigatePhoto(direction) {
        currentPhotoIndex =
          (currentPhotoIndex + direction + photos.length) % photos.length;
        updateLightboxImage();
      }

      function updateLightboxImage() {
        const photo = photos[currentPhotoIndex];
        const { data } = supabaseClient.storage
          .from("claim-photos")
          .getPublicUrl(`${claimId}/${photo.name}`);

        document.getElementById("lightbox-img").src = data.publicUrl;
      }

      function downloadCurrentPhoto() {
        const photo = photos[currentPhotoIndex];
        const { data } = supabaseClient.storage
          .from("claim-photos")
          .getPublicUrl(`${claimId}/${photo.name}`);

        const link = document.createElement("a");
        link.href = data.publicUrl;
        link.download = photo.name;
        link.click();
      }

      document.addEventListener("keydown", (e) => {
        const lightbox = document.getElementById("lightbox");
        if (!lightbox.classList.contains("active")) return;

        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") navigatePhoto(-1);
        if (e.key === "ArrowRight") navigatePhoto(1);
      });
    </script>
  </body>
</html>
